# =============================================================================
# E49: Fat-tree + SP-PIFO + MIDST + No SRPT (100% Load)
# =============================================================================
# Same fat-tree (k=4, 32 servers) as E48, but with MIDST feedback ENABLED.
# ALL flows use priority=0 (no SRPT) — realistic deployment.
#
# KEY HYPOTHESIS: SP-PIFO should be the IDEAL scheduler for MIDST because:
# 1. No admission gate → no starvation risk (unlike AIFO/PACKS)
# 2. Multi-queue scheduling → MIDST penalty creates priority differentiation
# 3. Without SRPT, Q0-Q4 all get rank=0 traffic → effectively FIFO
# 4. MIDST penalty (800,000) pushes bursty flows to Q4 → creates two classes:
#    - Normal: Q0 (served first)
#    - Bursty: Q4 (served last)
# 5. No packet drops from scheduling → only TCP congestion control limits flows
#
# This is the cleanest test of MIDST's scheduling value:
# penalty → queue demotion → delayed service for bursty flows
# No admission-control confounds (AIFO starvation, PACKS rejection).
#
# Compare to: E48 (baseline no MIDST), E45 (PACKS + MIDST no SRPT)
# =============================================================================

scenario_topology_file=example/topologies/fat_tree/fat_tree_k4.topology
scenario_topology_extend_with_servers=regular
scenario_topology_extend_servers_per_tl_node=4

seed=123
run_time_ns=1000000000

# TCP with NO SRPT: all flows use priority=0
transport_layer=tcp
network_device=ecmp_switch
network_device_routing=ecmp
network_device_intermediary=demo

link=perfect_simple
link_delay_ns=500
link_bandwidth_bit_per_ns=10

# Buffer: 150KB per port (same as E43)
output_port_max_queue_size_bytes=150000

enable_generate_human_readable_flow_completion_log=true

# Lightweight logging
enable_inversions_tracking=true
enable_log_port_queue_state=false
traffic_flow_size_dist=pfabric_web_search_lower_bound

run_folder_name=e49_sppifo_midst_no_srpt_fattree_100
run_folder_base_dir=temp/new_experiments/fattree

output_port=midst_feedback
midst_feedback_queue_type=new_sp_pifo

# MIDST detection — same thresholds as E43 (calibrated for fat-tree)
midst_sketch_size=256
midst_num_hash_functions=3
midst_high_watermark_packets=20
midst_low_watermark_packets=2
midst_burst_threshold=20

# SP-PIFO multi-queue — SCALED FOR BYTE RANKS
midst_sppifo_num_queues=5
midst_sppifo_rank_delta=200000
# M4 FIX: Semantic penalty target — auto-computes penalty = (numQueues-1) × rankDelta
# "LAST" → bursty flows pushed to the last queue (Q4 with numQueues=5)
# Replaces hardcoded midst_sppifo_congestion_penalty_rank=800000
midst_penalty_target_queue=LAST

# Buffer skew is NOT part of the original SP-PIFO paper design.
# E48 (baseline) uses default skew=1.0 (equal distribution).
# Removing skew from E49 ensures fair MIDST-only comparison: the ONLY
# difference between E48 and E49 is now MIDST feedback, not buffer allocation.

# Adaptive heavy-hitter detection (same as E43)
midst_adaptive_threshold_fraction=0.05

# Disable port-level VFL (SP-PIFO has no admission gate)
midst_port_vfl_fraction=1.0

# 100% Load microburst traffic
traffic=microburst
microburst_steady_lambda=2000
microburst_burst_lambda=200000
microburst_fraction=10
microburst_burst_duration_ns=10000000
microburst_burst_interval_ns=40000000
