# =============================================================================
# E47: Fat-tree + AIFO + MIDST + No SRPT (100% Load)
# =============================================================================
# Same fat-tree (k=4, 32 servers) as E46, but with MIDST feedback ENABLED.
# ALL flows use priority=0 (no SRPT) — realistic deployment.
#
# KEY HYPOTHESIS: Without SRPT, all packets at rank=0. AIFO admits based on
# quantile comparison: rank < quantile(k) of recent window.
# MIDST penalty (800,000) makes bursty packets look like rank=800,000:
#   - Normal flows: rank=0 → easily admitted (0 < any quantile)
#   - Detected bursty flows: rank=800,000 → likely rejected
# With VFL, the admission gate sees virtual congestion during bursts,
# making rejection of bursty packets more aggressive.
#
# On fat-tree, fan-in creates real congestion at aggregation switches.
# Each port independently tracks VQ → localized detection and penalty.
#
# Compare to: E46 (baseline no MIDST), E44/E45 (PACKS no SRPT pair)
# =============================================================================

scenario_topology_file=example/topologies/fat_tree/fat_tree_k4.topology
scenario_topology_extend_with_servers=regular
scenario_topology_extend_servers_per_tl_node=4

seed=123
run_time_ns=1000000000

# TCP with NO SRPT: all flows use priority=0
transport_layer=tcp
network_device=ecmp_switch
network_device_routing=ecmp
network_device_intermediary=demo

link=perfect_simple
link_delay_ns=500
link_bandwidth_bit_per_ns=10

# Buffer: 150KB per port (same as E43)
output_port_max_queue_size_bytes=150000

enable_generate_human_readable_flow_completion_log=true

# Lightweight logging
enable_inversions_tracking=true
enable_log_port_queue_state=false
traffic_flow_size_dist=pfabric_web_search_lower_bound

run_folder_name=e47_aifo_midst_no_srpt_fattree_100
run_folder_base_dir=temp/new_experiments/fattree

output_port=midst_feedback
midst_feedback_queue_type=real_aifo

# MIDST detection — same thresholds as E43 (calibrated for fat-tree)
midst_sketch_size=256
midst_num_hash_functions=3
midst_high_watermark_packets=20
midst_low_watermark_packets=2
midst_burst_threshold=20

# AIFO admission control with MIDST penalty
aifo_k=0.2
aifo_window_size=64
aifo_sample_count=1
# M5b FIX: AIFO-specific admission penalty — bursty flow rank inflated → rejected by quantile gate
# "REJECT" → penalty=1,000,000,000 (guaranteed quantile test failure regardless of window composition)
# AIFO has no multi-queue scheduling — penalty is purely for admission rejection, not queue demotion
aifo_admission_penalty=REJECT

# AIFO congestion detection (rejection-rate based)
aifo_use_rejection_rate_detection=true
aifo_rejection_rate_threshold=0.05
aifo_rejection_window_size=1000

# Virtual Fill Level — bursty flows see virtual queue depth at admission gate
midst_use_virtual_fill_level=true

# Adaptive heavy-hitter detection (same as E43)
midst_adaptive_threshold_fraction=0.05

midst_real_aifo_logging_enabled=false

# 100% Load microburst traffic
traffic=microburst
microburst_steady_lambda=2000
microburst_burst_lambda=200000
microburst_fraction=10
microburst_burst_duration_ns=10000000
microburst_burst_interval_ns=40000000
