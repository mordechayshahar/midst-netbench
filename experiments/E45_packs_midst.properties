# =============================================================================
# E45: Fat-tree + PACKS + MIDST + No SRPT (100% Load)
# =============================================================================
# Same fat-tree (k=4, 32 servers) as E44, but with MIDST feedback ENABLED.
# ALL flows use priority=0 (no SRPT) — realistic deployment.
#
# KEY HYPOTHESIS: Without SRPT, all flows arrive at rank=0 → all in Q0.
# MIDST penalty (800,000) is the ONLY source of differentiation:
#   - Normal flows: rank=0 → Q0 (priority service)
#   - Detected bursty flows: rank=800,000 → Q4 (delayed service)
# This creates a two-class system purely from congestion detection.
# With queue_buffer_skew=2.0, Q0 gets 2x more buffer → better service.
#
# The PACKS admission gate also rejects bursty packets (VFL + rank penalty)
# during congestion, further protecting normal flows.
#
# Compare to: E44 (baseline no MIDST), E43 (partial SRPT + MIDST)
# =============================================================================

scenario_topology_file=example/topologies/fat_tree/fat_tree_k4.topology
scenario_topology_extend_with_servers=regular
scenario_topology_extend_servers_per_tl_node=4

seed=123
run_time_ns=1000000000

# TCP with NO SRPT: all flows use priority=0 (realistic — flow sizes unknown)
transport_layer=tcp
network_device=ecmp_switch
network_device_routing=ecmp
network_device_intermediary=demo

link=perfect_simple
link_delay_ns=500
link_bandwidth_bit_per_ns=10

# Buffer: 150KB per port (same as E43)
output_port_max_queue_size_bytes=150000

enable_generate_human_readable_flow_completion_log=true

# Lightweight logging
enable_inversions_tracking=true
enable_log_port_queue_state=false
traffic_flow_size_dist=pfabric_web_search_lower_bound

run_folder_name=e45_packs_midst_no_srpt_fattree_100
run_folder_base_dir=temp/new_experiments/fattree

output_port=midst_feedback
midst_feedback_queue_type=packs

# MIDST detection — same thresholds as E43 (calibrated for fat-tree)
midst_sketch_size=256
midst_num_hash_functions=3
midst_high_watermark_packets=20
midst_low_watermark_packets=2
midst_burst_threshold=20

# PACKS multi-queue — SCALED FOR BYTE RANKS
midst_sppifo_num_queues=5
midst_sppifo_rank_delta=200000
# M5a FIX: PACKS-specific semantic penalty target — auto-computes penalty = (numQueues-1) × rankDelta
# "LAST" → bursty flows demoted to Q4 AND rank-inflated for admission rejection
# Replaces both midst_sppifo_congestion_penalty_rank=800000 (dead for PACKS) and aifo_rank_penalty=800000
packs_penalty_target_queue=LAST

# PACKS admission control with MIDST penalty
aifo_k=0.2
aifo_window_size=64
aifo_sample_count=1

# AIFO congestion detection (rejection-rate based)
aifo_use_rejection_rate_detection=true
aifo_rejection_rate_threshold=0.05
aifo_rejection_window_size=1000

# Virtual Fill Level — critical for PACKS admission gate
midst_use_virtual_fill_level=true

# This property was DEAD for PACKS — RealPACKSQueue has no per-queue limits.
# Buffer skew only applies to NewCanonicalSPPIFOQueue (SP-PIFO).

# Adaptive heavy-hitter detection (same as E43)
midst_adaptive_threshold_fraction=0.05

# 100% Load microburst traffic
traffic=microburst
microburst_steady_lambda=2000
microburst_burst_lambda=200000
microburst_fraction=10
microburst_burst_duration_ns=10000000
microburst_burst_interval_ns=40000000
